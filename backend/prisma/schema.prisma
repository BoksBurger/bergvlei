generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model DailyProgress {
  id               String   @id
  userId           String
  date             DateTime @db.Date
  riddlesSolved    Int      @default(0)
  riddlesAttempted Int      @default(0)
  streakActive     Boolean  @default(true)
  createdAt        DateTime @default(now())
  User             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([date])
  @@index([userId, date])
}

model Leaderboard {
  id            String   @id
  userId        String
  username      String
  period        String
  score         Int
  riddlesSolved Int
  averageTime   Float?
  rank          Int?
  createdAt     DateTime @default(now())
  updatedAt     DateTime

  @@unique([userId, period])
  @@index([period, score])
  @@index([rank])
}

model Riddle {
  id             String          @id
  question       String
  answer         String
  hints          String[]
  difficulty     DifficultyLevel
  category       String?
  aiGenerated    Boolean         @default(true)
  aiModel        String?
  timesAttempted Int             @default(0)
  timesSolved    Int             @default(0)
  averageTime    Int?
  isActive       Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime
  RiddleAttempt  RiddleAttempt[]

  @@index([category])
  @@index([difficulty])
  @@index([isActive])
}

model RiddleAttempt {
  id          String    @id
  userId      String
  riddleId    String
  solved      Boolean   @default(false)
  attempts    Int       @default(1)
  hintsUsed   Int       @default(0)
  timeSpent   Int?
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  Riddle      Riddle    @relation(fields: [riddleId], references: [id], onDelete: Cascade)
  User        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([riddleId])
  @@index([solved])
  @@index([startedAt])
  @@index([userId])
}

model Subscription {
  id                  String             @id
  userId              String
  revenueCatAppUserId String?            @unique
  revenueCatProductId String?
  status              SubscriptionStatus @default(ACTIVE)
  tier                SubscriptionTier
  currentPeriodStart  DateTime?
  currentPeriodEnd    DateTime?
  cancelAtPeriodEnd   Boolean            @default(false)
  trialStart          DateTime?
  trialEnd            DateTime?
  createdAt           DateTime           @default(now())
  updatedAt           DateTime
  User                User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([revenueCatAppUserId])
  @@index([userId])
}

model User {
  id                 String           @id
  email              String           @unique
  password           String
  username           String?          @unique
  subscriptionTier   SubscriptionTier @default(FREE)
  isPremium          Boolean          @default(false)
  riddlesPerDayLimit Int              @default(5)
  riddlesTodayCount  Int              @default(0)
  lastRiddleDate     DateTime?
  totalRiddlesSolved Int              @default(0)
  currentStreak      Int              @default(0)
  longestStreak      Int              @default(0)
  createdAt          DateTime         @default(now())
  updatedAt          DateTime
  DailyProgress      DailyProgress[]
  RiddleAttempt      RiddleAttempt[]
  Subscription       Subscription[]
  UserStats          UserStats?

  @@index([email])
  @@index([subscriptionTier])
}

model UserStats {
  id                  String   @id
  userId              String   @unique
  totalRiddlesSolved  Int      @default(0)
  totalAttempts       Int      @default(0)
  totalHintsUsed      Int      @default(0)
  totalTimeSpent      Int      @default(0)
  easyRiddlesSolved   Int      @default(0)
  mediumRiddlesSolved Int      @default(0)
  hardRiddlesSolved   Int      @default(0)
  expertRiddlesSolved Int      @default(0)
  averageTime         Float?
  accuracy            Float?
  lastActive          DateTime @default(now())
  updatedAt           DateTime
  User                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum DifficultyLevel {
  EASY
  MEDIUM
  HARD
  EXPERT
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  EXPIRED
  TRIAL
}

enum SubscriptionTier {
  FREE
  PREMIUM
}
